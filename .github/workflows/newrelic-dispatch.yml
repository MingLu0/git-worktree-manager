name: New Relic Snapshot (Dispatch)

on:
  workflow_dispatch:
    inputs:
      sinceMinutes:
        description: Lookback window in minutes
        required: true
        default: '1440'
      limit:
        description: How many top items to return
        required: true
        default: '10'

jobs:
  snapshot:
    runs-on: ubuntu-latest

    steps:
      - name: Verify secrets
        shell: bash
        env:
          NEW_RELIC_API_KEY: ${{ secrets.NEW_RELIC_API_KEY }}
          NEW_RELIC_ACCOUNT_ID: ${{ secrets.NEW_RELIC_ACCOUNT_ID }}
        run: |
          set -euo pipefail
          test -n "${NEW_RELIC_API_KEY:-}" || (echo "Missing NEW_RELIC_API_KEY" && exit 1)
          test -n "${NEW_RELIC_ACCOUNT_ID:-}" || (echo "Missing NEW_RELIC_ACCOUNT_ID" && exit 1)

      - name: Query NerdGraph (custom events + discovery)
        shell: bash
        env:
          NEW_RELIC_API_KEY: ${{ secrets.NEW_RELIC_API_KEY }}
          ACCOUNT_ID: ${{ secrets.NEW_RELIC_ACCOUNT_ID }}
          SINCE_MIN: ${{ inputs.sinceMinutes }}
          LIMIT: ${{ inputs.limit }}
        run: |
          set -euo pipefail
          URL="https://api.newrelic.com/graphql"

          # Notes:
          # - We keep GraphQL variables minimal, and inject SINCE/LIMIT into the NRQL strings.
          # - keyset() helps us discover what attributes exist (e.g., durationMs, success, countryCode, etc.).

          QUERY="query(\$accountId: Int!) { actor { account(id: \$accountId) {
            eventTypes: nrql(query: \"SHOW EVENT TYPES SINCE 1 day ago\") { results }

            openWorktreeKeys: nrql(query: \"SELECT keyset() FROM OPEN_WORKTREE SINCE ${SINCE_MIN} minutes ago LIMIT 50\") { results }
            listWorktreesKeys: nrql(query: \"SELECT keyset() FROM LIST_WORKTREES SINCE ${SINCE_MIN} minutes ago LIMIT 50\") { results }
            createWorktreeKeys: nrql(query: \"SELECT keyset() FROM CREATE_WORKTREE SINCE ${SINCE_MIN} minutes ago LIMIT 50\") { results }
            deleteWorktreeKeys: nrql(query: \"SELECT keyset() FROM DELETE_WORKTREE SINCE ${SINCE_MIN} minutes ago LIMIT 50\") { results }

            usageOpen: nrql(query: \"SELECT count(*) AS count FROM OPEN_WORKTREE SINCE ${SINCE_MIN} minutes ago\") { results }
            usageList: nrql(query: \"SELECT count(*) AS count FROM LIST_WORKTREES SINCE ${SINCE_MIN} minutes ago\") { results }
            usageCreate: nrql(query: \"SELECT count(*) AS count FROM CREATE_WORKTREE SINCE ${SINCE_MIN} minutes ago\") { results }
            usageDelete: nrql(query: \"SELECT count(*) AS count FROM DELETE_WORKTREE SINCE ${SINCE_MIN} minutes ago\") { results }

            # Location (based on discovered attribute: country_code)
            locOpen_country: nrql(query: \"SELECT count(*) AS hits FROM OPEN_WORKTREE SINCE ${SINCE_MIN} minutes ago FACET country_code LIMIT ${LIMIT}\") { results }
            locCreate_country: nrql(query: \"SELECT count(*) AS hits FROM CREATE_WORKTREE SINCE ${SINCE_MIN} minutes ago FACET country_code LIMIT ${LIMIT}\") { results }
            locList_country: nrql(query: \"SELECT count(*) AS hits FROM LIST_WORKTREES SINCE ${SINCE_MIN} minutes ago FACET country_code LIMIT ${LIMIT}\") { results }
            locDelete_country: nrql(query: \"SELECT count(*) AS hits FROM DELETE_WORKTREE SINCE ${SINCE_MIN} minutes ago FACET country_code LIMIT ${LIMIT}\") { results }
          } } }"

          PAYLOAD=$(QUERY="$QUERY" python3 -c 'import json,os; print(json.dumps({"query": os.environ["QUERY"], "variables": {"accountId": int(os.environ["ACCOUNT_ID"])}}))')

          curl -sS -X POST "$URL" \
            -H "Content-Type: application/json" \
            -H "API-Key: $NEW_RELIC_API_KEY" \
            --data "$PAYLOAD" \
            | tee nerdgraph.json

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: newrelic-snapshot
          path: nerdgraph.json

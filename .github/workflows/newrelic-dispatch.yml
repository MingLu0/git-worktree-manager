name: New Relic Snapshot (Dispatch)

on:
  workflow_dispatch:
    inputs:
      sinceMinutes:
        description: Lookback window in minutes
        required: true
        default: '60'
      limit:
        description: How many top items to return
        required: true
        default: '10'

jobs:
  snapshot:
    runs-on: ubuntu-latest

    steps:
      - name: Verify secrets
        shell: bash
        env:
          NEW_RELIC_API_KEY: ${{ secrets.NEW_RELIC_API_KEY }}
          NEW_RELIC_ACCOUNT_ID: ${{ secrets.NEW_RELIC_ACCOUNT_ID }}
        run: |
          set -euo pipefail
          test -n "${NEW_RELIC_API_KEY:-}" || (echo "Missing NEW_RELIC_API_KEY" && exit 1)
          test -n "${NEW_RELIC_ACCOUNT_ID:-}" || (echo "Missing NEW_RELIC_ACCOUNT_ID" && exit 1)

      - name: Query NerdGraph (account-wide)
        shell: bash
        env:
          NEW_RELIC_API_KEY: ${{ secrets.NEW_RELIC_API_KEY }}
          ACCOUNT_ID: ${{ secrets.NEW_RELIC_ACCOUNT_ID }}
          SINCE_MIN: ${{ inputs.sinceMinutes }}
          LIMIT: ${{ inputs.limit }}
        run: |
          set -euo pipefail
          URL="https://api.newrelic.com/graphql"

          QUERY="query(\$accountId: Int!) { actor { account(id: \$accountId) { topTx: nrql(query: \"SELECT count(*) AS calls, average(duration) AS avgDuration, percentile(duration, 95) AS p95 FROM Transaction SINCE ${SINCE_MIN} minutes ago LIMIT ${LIMIT}\") { results } topErrors: nrql(query: \"SELECT count(*) AS hits, latest(timestamp) AS lastSeen FROM TransactionError SINCE ${SINCE_MIN} minutes ago FACET error.message LIMIT ${LIMIT}\") { results } topApps: nrql(query: \"SELECT count(*) AS hits FROM Transaction SINCE ${SINCE_MIN} minutes ago FACET appName LIMIT ${LIMIT}\") { results } } } }"

          PAYLOAD=$(QUERY="$QUERY" python3 -c 'import json,os; print(json.dumps({"query": os.environ["QUERY"], "variables": {"accountId": int(os.environ["ACCOUNT_ID"])}}))')

          curl -sS -X POST "$URL" \
            -H "Content-Type: application/json" \
            -H "API-Key: $NEW_RELIC_API_KEY" \
            --data "$PAYLOAD" \
            | tee nerdgraph.json

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: newrelic-snapshot
          path: nerdgraph.json

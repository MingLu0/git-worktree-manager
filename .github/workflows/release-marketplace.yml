name: Release to JetBrains Marketplace

on:
  # Tag-based releases (recommended): push v1.2.3, etc.
  push:
    tags:
      - 'v*'

  # Optional manual run for testing the pipeline without publishing
  workflow_dispatch:
    inputs:
      channel:
        description: 'Marketplace channel (leave empty for default/stable)'
        required: false
        default: ''
      publish:
        description: 'Actually publish (true) or just build (false)'
        required: true
        default: 'false'

# Prevent overlapping publishes
concurrency:
  group: marketplace-publish
  cancel-in-progress: false

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v4

      # --- Signing material (optional but recommended) ---
      # Provide these as GitHub Actions secrets if you want CI to sign.
      # - PLUGIN_CERT_CHAIN_B64: base64 of chain.crt
      # - PLUGIN_PRIVATE_KEY_B64: base64 of private.pem
      # - PLUGIN_SIGNING_PASSWORD: password for the private key
      - name: Write signing files (if provided)
        shell: bash
        run: |
          set -euo pipefail
          if [[ -n "${PLUGIN_CERT_CHAIN_B64:-}" ]]; then
            echo "$PLUGIN_CERT_CHAIN_B64" | base64 -d > chain.crt
            echo "Wrote chain.crt"
          fi
          if [[ -n "${PLUGIN_PRIVATE_KEY_B64:-}" ]]; then
            echo "$PLUGIN_PRIVATE_KEY_B64" | base64 -d > private.pem
            echo "Wrote private.pem"
          fi
        env:
          PLUGIN_CERT_CHAIN_B64: ${{ secrets.PLUGIN_CERT_CHAIN_B64 }}
          PLUGIN_PRIVATE_KEY_B64: ${{ secrets.PLUGIN_PRIVATE_KEY_B64 }}

      - name: Verify required secrets are present
        shell: bash
        run: |
          set -euo pipefail
          if [[ -z "${INTELLIJ_PLATFORM_PUBLISHING_TOKEN:-}" ]]; then
            echo "Missing INTELLIJ_PLATFORM_PUBLISHING_TOKEN secret."
            echo "Set it in: GitHub repo → Settings → Secrets and variables → Actions."
            exit 1
          fi
          if [[ -z "${PLUGIN_SIGNING_PASSWORD:-}" ]]; then
            echo "Missing PLUGIN_SIGNING_PASSWORD secret."
            echo "Set it in: GitHub repo → Settings → Secrets and variables → Actions."
            exit 1
          fi
        env:
          INTELLIJ_PLATFORM_PUBLISHING_TOKEN: ${{ secrets.INTELLIJ_PLATFORM_PUBLISHING_TOKEN }}
          PLUGIN_SIGNING_PASSWORD: ${{ secrets.PLUGIN_SIGNING_PASSWORD }}

      - name: Verify tag matches Gradle version
        if: ${{ github.event_name == 'push' }}
        shell: bash
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF_NAME}"          # e.g., v1.1.0
          EXPECTED="${TAG#v}"               # 1.1.0
          ACTUAL=$(./gradlew -q properties | sed -n 's/^version: //p' | head -n 1)
          echo "Tag: $TAG"
          echo "Gradle version: $ACTUAL"
          if [[ "$ACTUAL" != "$EXPECTED" ]]; then
            echo "ERROR: Tag version ($EXPECTED) does not match Gradle version ($ACTUAL)."
            echo "Bump version in build.gradle.kts, commit to master, then tag again."
            exit 1
          fi

      - name: Build and sign plugin
        run: ./gradlew --no-daemon clean buildPlugin signPlugin --stacktrace
        env:
          PLUGIN_SIGNING_PASSWORD: ${{ secrets.PLUGIN_SIGNING_PASSWORD }}

      - name: Publish to Marketplace (tag push)
        if: ${{ github.event_name == 'push' }}
        env:
          INTELLIJ_PLATFORM_PUBLISHING_TOKEN: ${{ secrets.INTELLIJ_PLATFORM_PUBLISHING_TOKEN }}
          PLUGIN_SIGNING_PASSWORD: ${{ secrets.PLUGIN_SIGNING_PASSWORD }}
        run: |
          ./gradlew --no-daemon publishPlugin --stacktrace

      - name: Publish to Marketplace (manual dispatch)
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.publish == 'true' }}
        env:
          INTELLIJ_PLATFORM_PUBLISHING_TOKEN: ${{ secrets.INTELLIJ_PLATFORM_PUBLISHING_TOKEN }}
          PLUGIN_SIGNING_PASSWORD: ${{ secrets.PLUGIN_SIGNING_PASSWORD }}
        run: |
          # Optional: pass a channel if you use EAP channels.
          if [[ -n "${{ inputs.channel }}" ]]; then
            ./gradlew --no-daemon publishPlugin -PintellijPlatformPublishingChannel='${{ inputs.channel }}' --stacktrace
          else
            ./gradlew --no-daemon publishPlugin --stacktrace
          fi
